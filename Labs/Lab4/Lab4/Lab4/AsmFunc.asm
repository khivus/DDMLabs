.586
.XMM
.MODEL flat, C

.DATA

one dd 1          ; ???? ??? ????????? ?? x
res dd 0          ; ???????? ?????????

i dd ?            ; ??????? ????????
temp dd ?         ; ????????? ??????????
xminone dd ?      ; ????????? ????????? ?? x

.CODE

extern cfunc:near  ; ?????????? ??????? ??????? ?? C++

public getf        ; ?????????? ????????? ?????????
getf proc C x:dword ; ?????? ????????? ? ?????????? x
    finit          ; ????????????? ????????????

    fld x          ; ???????? x ? ???? FPU
    fild one       ; ???????? ??????? ? ???? FPU
    fsub           ; ????????? ?? x ???????
    fstp xminone   ; ?????????? ?????????? ????????? ? xminone

yappy:
    fld xminone    ; ???????? xminone ? ???? FPU
    fild i         ; ???????? i ? ???? FPU
    fadd           ; ????????
    fstp temp      ; ?????????? ?????????? ? temp
    push temp      ; ????????? temp ? ???? ???????
    call cfunc     ; ????? ??????? ?? C
    fst temp       ; ?????????? ?????????? ???????

    fld res         ; ???????? ???????? res ? ??????? ????? FPU
    fcompp          ; ????????? ???? ???????? ? ????? ? ????????? ?????? ??????????
    fstsw ax        ; ?????????? ????????? ?????? ? ???????? AX
    sahf            ; ??????????? ?????? ?? ???????? AH ? ??????? FLAGS ? ??????????
    jb move_to_tmp  ; ???? ????????? ?????? ??????????? ?????????????

go_back:
    inc i          ; ????????? ????????
    cmp i, 4       ; ????????? ? 4
    jb yappy       ; ??????? ? yappy, ???? ??????
    jmp avoid      ; ??????? ? avoid

move_to_tmp:
    mov eax, temp  ; ??????????? ???????? temp ? eax
    mov res, eax   ; ??????????? eax ? res
    jmp go_back    ; ??????? ? go_back

avoid:
    fld res        ; ???????? res ? ???? FPU
    ret            ; ??????? ?? ?????????

getf endp          ; ????? ?????????
End                ; ????? ?????
